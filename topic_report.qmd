---
format: pdf
execute:
  echo: false
  warning: false
  message: false
params:
  topic: ""
  transactions_rds: ""
---

```{r}
#| label: prepare data

library(dplyr)
library(knitr)

if (!is.null(params$transactions_rds) && nzchar(params$transactions_rds)) {
  df <- readRDS(params$transactions_rds)
  # df <- init_data$transactions
} else {
  df <- data.frame(
    Datum = as.Date(character()),
    Bemerkung = character(),
    Betrag = numeric(),
    Konto = character(),
    Anlass = character(),
    stringsAsFactors = FALSE)
}

# Filter by topic
df <- df |> 
  filter(Anlass == params$topic) |> 
  mutate(
    Typ = ifelse(Betrag > 0, "income", "expenses")
  )
# df <- df |> 
#   filter(Anlass == "Kilbi 25") |> 
#   mutate(
#     Typ = ifelse(Betrag > 0, "income", "expenses")
#   )

income <- df |> filter(Typ == "income")
expences <- df |> filter(Typ == "expences")

total_income <- tibble(
  Typ = "Total Einnahmen",
  Betrag = sum(income$Betrag, na.rm = TRUE)
)

total_expenses <- tibble(
  Typ = "Total Ausgaben",
  Betrag = sum(expences$Betrag, na.rm = TRUE)
)

total <- tibble(
  Typ = ifelse(total_income$Betrag > total_expenses$Betrag, "Gewinn", "Verlust"),
  Betrag = sum(df$Betrag, na.rm = TRUE)
)

```

# Abrechnung `{r} params$topic` 

## Einnahmen

```{r}
#| label: Einnahmen

if (nrow(income) > 0) {
df |> 
  filter(Typ == "income") |> 
  select(Datum, Bemerkung, Betrag) |> 
  kable()
}

```

## Ausgaben

```{r}
#| label: Ausgaben

if (nrow(expences) > 0) {
  df |> 
  filter(Typ == "expences") |> 
  select(Datum, Bemerkung, Betrag) |> 
  kable()
}

```

## Zusammenfassung

```{r}
#| label: Zusammenfassung

if (nrow(df) > 0) {
total_income |> 
  bind_rows(total_expenses, total) |> 
  kable()
}

```