---
title: "Themenbericht"
format: pdf
execute:
  echo: false
  warning: false
  message: false
params:
  topic: ""
  transactions_rds: ""
---

```{r}
#| label: debug-chunk

print(str(params$transactions_rds))
```

```{r}
#| label: prepare data

library(dplyr)
library(knitr)

if (!is.null(params$transactions_rds) && nzchar(params$transactions_rds)) {
  df <- readRDS(params$transactions_rds)
} else {
  df <- data.frame(
    Datum = as.Date(character()),
    Bemerkung = character(),
    Betrag = numeric(),
    Konto = character(),
    Anlass = character(),
    stringsAsFactors = FALSE)
}

# make sure it is a data frame
df <- as.data.frame(df)

# check structure of df
print(str(df))
print(class(df))

# Filter by topic
df <- params$transactions %>%
  filter(Anlass == params$topic)

# Split Einnahmen/Ausgaben
income <- df %>% filter(Betrag > 0)
expenses <- df %>% filter(Betrag < 0)

total_income <- sum(income$Betrag, na.rm = TRUE)
total_expenses <- sum(abs(expenses$Betrag), na.rm = TRUE)
profit <- total_income - total_expenses
```

# Abrechnung `{r} params$topic` 

## Einnahmen

```{r}
if (nrow(income) > 0) {
  kable(income %>% select(Datum, Bemerkung, Betrag), align = "l l r", caption = "Einnahmen")
} else {
  cat("Keine Einnahmen gefunden.\n")
}
```

## Ausgaben

```{r}
if (nrow(expenses) > 0) {
  kable(expenses %>% select(Datum, Bemerkung, Betrag), align = "l l r", caption = "Ausgaben")
} else {
  cat("Keine Ausgaben gefunden.\n")
}
```

## Zusammenfassung

```{r}
cat(sprintf("**Total Einnahmen:** %.2f €\n\n", total_income))
cat(sprintf("**Total Ausgaben:** %.2f €\n\n", total_expenses))
cat(sprintf("**Gewinn/Verlust:** %.2f €", profit))
```