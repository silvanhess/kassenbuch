---
format: pdf
execute:
  echo: false
  warning: false
  message: false
params:
  topic: ""
  transactions_rds: ""
---

```{r}
#| label: prepare data

library(dplyr)
library(knitr)
library(formattable)

df <- readRDS(params$transactions_rds)
# df <- init_data$transactions

# Filter by topic
df <- df |> 
  filter(Anlass == params$topic) |> 
  mutate(Typ = ifelse(Betrag > 0, "income", "expences"))
# df <- df |> 
#   filter(Anlass == "Kilbi 25") |> 
#   mutate(
#     Typ = ifelse(Betrag > 0, "income", "expenses")
#   )

income <- df |> filter(Typ == "income")
expences <- df |> filter(Typ == "expences")

total_income <- tibble(
  Typ = "Total Einnahmen",
  Betrag = sum(income$Betrag, na.rm = TRUE)
)

total_expenses <- tibble(
  Typ = "Total Ausgaben",
  Betrag = sum(expences$Betrag, na.rm = TRUE)
)

result <- tibble(
  Typ = ifelse(total_income$Betrag > total_expenses$Betrag, "Gewinn", "Verlust"),
  Betrag = sum(df$Betrag, na.rm = TRUE)
)

```

# Abrechnung `{r} params$topic` 

## Einnahmen

```{r}
#| label: Einnahmen

if (nrow(income) > 0) {
  df |> 
    filter(Typ == "income") |> 
    select(Datum, Bemerkung, Betrag) |> 
    arrange(Datum) |> 
    mutate(Datum = format(Datum, "%d.%m.%Y"), 
    Betrag = currency(Betrag, "Fr.")
    ) |> 
    kable()
}

```

## Ausgaben

```{r}
#| label: Ausgaben

if (nrow(expences) > 0) {
  df |> 
    filter(Typ == "expences") |> 
    select(Datum, Bemerkung, Betrag) |> 
    arrange(Datum) |> 
    mutate(Datum = format(Datum, "%d.%m.%Y"), 
    Betrag = currency(Betrag, "Fr.")
    ) |> 
    kable()
}

```

## Zusammenfassung

```{r}
#| label: Zusammenfassung

if (nrow(df) > 0) {
  total_income |> 
    bind_rows(total_expenses, result) |> 
    mutate(Betrag = currency(Betrag, "Fr.")) |> 
    kable()
}

```